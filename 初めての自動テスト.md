# 初めての自動テスト　2021.06.20

## 基本
- テストのピラミッド
  - ユニット >　統合 >　UI
  - 多くのアプリケーションは、3つの層で構成される
    - ロジック > サービス > UI
  - 「ユニット ↔︎ ロジック」「統合 ↔︎ サービス」「UI ↔︎ UI」というように対応している

- UIテスト
  - ○エンドツーエンド（ロジック〜UIまで全ての層を通過し、全てがつながっていることを保証する）
  - ○ユーザーと同じ対象を見る
  - ×高コストで遅い、壊れやすい

- 統合テスト
  - UIを通過せず、サービス層をテストする。
  - ○WebサービスとAPIのテスト
  - ○繋がりをみる
  - ×詳細さに欠ける
    - 「何か」が壊れていることはわかっても、厳密に「どこ」が壊れているかまではわからない。

- ユニットテスト
  - ○超高速
  - ○失敗した時にどの部分が上手くいかなかったのか厳密にわかる
  - ○多目的に利用できる
  - ×統合部分の確認に弱い

- 親指の法則
  1. UIよりもユニットテストを優先すること
  2. ユニットテストで埋められない部分を統合テストでカバーすること
  3. UIテストは限定的に使うこと

　※常に、下の層でテストできないか検討すること
　※すべての自動化しようとせず、過不足なく自動化すること

- 上と下の層でテストが重複する
  - 上にあるテストは下にあるテストを内包しているため、部分的な重複は避けられない。
  - しかし、上と下でスコープや意図が異なる
    - Ex
      - ユニットテスト
        - スピードとフィードバックが強み。
        - 開発中に重要な点についてフィードバックを得たいときに書く
          - 設計を正しく反映しているか？
          - 最後の変更で何かを壊していないか？
          - 私たちの想定と特殊なケースはすべて整合性が取れているか？
          - 新しい機能を追加することは安全か？
      - UIテスト、統合テスト
        - システムがきちんとつながっていることを確認。
  - テストの意図が重複していなければ、機能面での重複は問題ない。

| ユニットテスト | UIテスト|
|:---:|:----:|
|開発のためのもの|検証のためのもの|
|フィードバックが速い|フィードバックが遅い|
|下位レベル|上位レベル|
|局所的|エンドツーエンド|
|安価|高価|
|実行が速い|実行が遅い|
|頑健|壊れやすい|
|信頼できる/結果が一意に決まる|当てにならない/結果が一意に決まらない|
|開発に使う|テストに使う|
|開発者視点のテスト|顧客視点のテスト|

## UIテスト
- UIテストはエンドツーエンドのスモークテストとして有用
  - スモークテストとは、システムが基本的なレベルで稼働していることを確認する高レベルのテスト
    - アプリケーションが適切にデプロイされていること
    - 環境が適切に設定されていること
    - アーキテクチャのすべてのパーツが正しく接続されていること
- キャプチャーリプレイのスクリプトよりも手で書いたテストコードの方が望ましい
  - キャプチャーリプレイの欠点
    - UIを少しでも変更しただけで壊れる
    - 可読性が低下する
    - コーディングしないので、コードを整理することができない
- テストでアサーションを入れるときは、HTMLタグを対象にする
- ページの要素を選択するには、CSSセレクタを使う（※）
- HTMLのIDが付いている要素は取得しやすい（※）
  - 要素の位置に依存したUTテストを書くと、UIの変更でテストが壊れてしまう。
    - Ex.)`$("input[type=text]")[0]` (jQuery)
- （※）に対してよりよい解決案（[参考](https://qiita.com/akameco/items/519f7e4d5442b2a9d2da)）
  - カスタム属性を使う
    - 例えば、`data-testid`のようなカスタム属性を使って各要素を識別する。
    - CSSセレクタやHTMLのIDなどは、スタイルと密結合になってしまい、変更に弱くなってしまう
    - プロダクションから消したい場合は、Babelなどでコンパイル時に消すことも可能
- テストケース内でよく使われるURLを記述するときには、変数を使う
- UTテストを書くときは、UIとなるべく疎結合に、詳細になりすぎないように注意
  - 緩く保つことがコツ
  - アンチパターン例
    - メッセージの内容までチェックする
      - メッセージの内容はチェックせず、存在の有無をチェックする

## 統合テスト


## ユニットテスト
- テストのピラミッドの基盤であり、他の階層に比べて多くのテストを担う
- 非常に高速に実行できるため、迅速なフィードバックを得られる
- 局所的に書くことが多く、ネットワークに接続するような処理は避けた方が良い
- モック化は、テストしたいコードに置いてアクセス困難な箇所もテストできるようにするための技術
- テストコードが十分かどうか判断するには？
  - 正しく動くことを保証する
  - 壊れる可能性のある箇所はすべてテストする
    - よくあるエラー
    - エッジケース
    - 特殊な条件
    - etc...
  - テストファースト（TDD）
    - メリット
      - 必要なものだけ実装できる
      - テストしやすく部品化された状態でシステムを設計、実装できる
      - 実装が完了すると同時に、その動作を保証するユニットテストも出来上がっている


## JSを使ったブラウザ上のUT
- UIをテストするが、エンドツーエンドで動くわけではない（ブラウザ上での動作のみに注目）
- テストデータとしてHTMLを直接テストコードに埋め込む場合
  - メリット
    - テストデータとテストコードが近くに配置されるため可読性が向上する
    - 必要なHTMLだけを対象にできるので、デバッグやトラブルシューティングが楽になる
  - デメリット
    - 実際のHTMLと乖離するリスクがある
    - 